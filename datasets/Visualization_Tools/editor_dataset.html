
<!DOCTYPE html>
<html lang="gl">
<head>
<meta charset="UTF-8">
<title>Editor de Dataset RAG con Noticias</title>
<style>
  body { font-family: sans-serif; margin: 20px; display: flex; flex-direction: column; }
  .container { display: flex; justify-content: space-between; }
  .editor { width: 48%; }
  .news { width: 48%; overflow-y: auto; max-height: 600px; }
  textarea { width: 100%; resize: vertical; }
  #questionField { height: 50px; }
  #answersField { height: 100px; }
  #contextField { height: 200px; }
  input, textarea { margin-bottom: 10px; }
  .nav { margin: 10px 0; }
  h2 { margin-top: 20px; }
  .title { font-weight: bold; margin-bottom: 10px; }
  .news-content { width: 100%; height: 400px; border: 1px solid #ccc; padding: 10px; background: #f4f4f4; overflow-y: auto; }
</style>
</head>
<body>

<h1>Editor de Dataset RAG con Noticias</h1>

<label for="fileInputQuestions"><b>ðŸ“„ Cargar dataset de preguntas (JSON)</b></label><br>
<input type="file" id="fileInputQuestions"><br><br>

<label for="fileInputNews"><b>ðŸ“° Cargar dataset de noticias (JSONL)</b></label><br>
<input type="file" id="fileInputNews"><br><br>

<div id="jumpBox" style="display:none;">
  <input type="number" id="idJumpInput" placeholder="Ir a ID...">
  <button id="idJumpBtn">Ir</button>
  <span id="jumpResult"></span>
</div>

<div id="editor" style="display:none;">
  <div class="container">
    <div class="editor">
      <p><b>ID:</b> <span id="idField"></span></p>
      <p><b>Source ID:</b> <span id="sourceField"></span></p>
      <p><b>Pregunta:</b><br><textarea id="questionField"></textarea></p>
      <p><b>Respostas:</b><br><textarea id="answersField"></textarea></p>
      <p><b>Contexto:</b><br><textarea id="contextField"></textarea></p>
      <p><b>ParÃ¡grafos Ã­ndice:</b><br><input id="indicesField"></p>

      <div class="nav">
        <button id="prevBtn">Anterior</button>
        <button id="nextBtn">Seguinte</button>
        <button id="saveBtn">Gardar cambios</button>
        <button id="downloadBtn">Descargar JSON</button>
      </div>
    </div>
    <div class="news">
      <h2>Texto da noticia</h2>
      <div id="newsTitle" class="title"></div>
      <div id="newsText" class="news-content"></div>
    </div>
  </div>
</div>

<script>
let dataQuestions = [];
let dataNews = {};
let currentIndex = 0;

document.getElementById('fileInputQuestions').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      dataQuestions = JSON.parse(e.target.result);
      currentIndex = 0;
      document.getElementById('editor').style.display = 'block';
      document.getElementById('jumpBox').style.display = 'block';
      showRecord();
    } catch (err) {
      alert("Erro ao ler o JSON de preguntas: " + err);
    }
  };
  reader.readAsText(file);
});

document.getElementById('fileInputNews').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const newsData = e.target.result.split('\n').map(line => {
        try {
          return JSON.parse(line);
        } catch (err) {
          return null;
        }
      }).filter(item => item);
      dataNews = Object.fromEntries(newsData.map(item => [item.source_id, item]));
      alert("Noticias cargadas correctamente!");
    } catch (err) {
      alert("Erro ao ler o JSON de noticias: " + err);
    }
  };
  reader.readAsText(file);
});

function showRecord() {
  const item = dataQuestions[currentIndex];
  document.getElementById('idField').textContent = item.id;
  document.getElementById('sourceField').textContent = item.source_id;
  document.getElementById('questionField').value = item.question;
  document.getElementById('answersField').value = JSON.stringify(item.answer, null, 2);
  document.getElementById('contextField').value = item.context;
  document.getElementById('indicesField').value = item.context_paragraph_indices.join(", ");

  const news = dataNews[item.source_id];
  if (news) {
    document.getElementById('newsTitle').textContent = news.title;
    document.getElementById('newsText').innerHTML = news.text.replace(/\n/g, '<br><br>');
  } else {
    document.getElementById('newsTitle').textContent = "â€”";
    document.getElementById('newsText').textContent = "Non hai noticia cargada para este source_id.";
  }
}

function saveCurrentRecord() {
  const item = dataQuestions[currentIndex];
  item.question = document.getElementById('questionField').value;
  try {
    item.answer = JSON.parse(document.getElementById('answersField').value);
  } catch (e) {
    alert("Erro no formato das respostas (debe ser JSON vÃ¡lido)");
    return false;
  }
  item.context = document.getElementById('contextField').value;
  item.context_paragraph_indices = document.getElementById('indicesField').value.split(",").map(s => parseInt(s.trim())).filter(n => !isNaN(n));
  return true;
}

document.getElementById('prevBtn').onclick = function() {
  if (saveCurrentRecord() && currentIndex > 0) { currentIndex--; showRecord(); }
};

document.getElementById('nextBtn').onclick = function() {
  if (saveCurrentRecord() && currentIndex < dataQuestions.length - 1) { currentIndex++; showRecord(); }
};

document.getElementById('saveBtn').onclick = function() {
  if (saveCurrentRecord()) alert("Rexistro gardado na memoria!");
};

document.getElementById('downloadBtn').onclick = function() {
  const blob = new Blob([JSON.stringify(dataQuestions, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'dataset_editado.json';
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('idJumpBtn').onclick = function() {
  const idValue = parseInt(document.getElementById('idJumpInput').value);
  if (isNaN(idValue)) return;
  const foundIndex = dataQuestions.findIndex(item => item.id === idValue);
  if (foundIndex >= 0) {
    if (saveCurrentRecord()) {
      currentIndex = foundIndex;
      showRecord();
      document.getElementById('jumpResult').textContent = `Mostrando rexistro ${foundIndex+1} de ${dataQuestions.length}`;
    }
  } else {
    document.getElementById('jumpResult').textContent = "ID non atopado";
  }
};
</script>

</body>
</html>
